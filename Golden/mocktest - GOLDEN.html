<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mock Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #0078d7;
      color: white;
      width: 100%;
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
    }
    main {
      max-width: 800px;
      width: 90%;
      margin: 20px auto;
    }
    .controls {
      margin: 20px 0;
      text-align: center;
    }
    #fileInput { display: none; }
    .custom-btn {
      background: #0078d7;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }
    .custom-btn:hover { background: #005ea3; }
    .question-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }
    .question-card h3 { margin-top: 0; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .disabled { pointer-events: none; opacity: 0.6; }
    .active { border: 2px solid #0078d7; box-shadow: 0 0 8px rgba(0,120,215,0.6); }
    .locked { pointer-events: none; opacity: 1 !important; }
    button {
      background: #0078d7;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
      margin-top: 8px;
    }
    button:hover { background: #005ea3; }
    #restart { margin-top: 20px; display: none; }
    #scoreboard {
      margin: 20px 0;
      font-size: 1.2em;
      text-align: center;
    }
    #message {
      font-size: 1.1em;
      margin-top: 10px;
      font-weight: bold;
    }
    #message.excellent { color: green; }
    #message.good { color: #0078d7; }
    #message.fair { color: orange; }
    #message.poor { color: red; }

    /* Match the Following neat layout */
    .match-table {
      display: table;
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .match-row {
      display: table-row;
    }
    .match-cell {
      display: table-cell;
      padding: 6px 8px;
      vertical-align: middle;
    }
    .match-cell:first-child {
      font-weight: bold;
      width: 40%;
    }
    select {
      width: 100%;
      padding: 4px;
    }
  </style>
</head>
<body>
  <header id="test-title">Mock Test Application</header>
  <main>
    <div class="controls">
      <label for="fileInput" class="custom-btn">üìÇ Choose Test</label>
      <input type="file" id="fileInput" accept=".json">
    </div>
    <div id="test"></div>
    <div id="scoreboard"></div>
    <div style="text-align:center;">
      <button id="restart">üîÑ Restart Test</button>
    </div>
  </main>

  <script>
    let questions = [];
    let originalData = null;
    let score = 0;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          originalData = data;
          startTest();
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    });

    function startTest() {
      const container = document.getElementById("test");
      container.innerHTML = "";
      document.getElementById("restart").style.display = "none";
      document.getElementById("scoreboard").innerHTML = "";
      score = 0;

      document.getElementById("test-title").textContent = originalData.title || "Mock Test";

      questions = shuffle(originalData.questions.map(q => {
        if (q.options) q.options = shuffle([...q.options]);
        return q;
      }));

      renderTest(questions);

      questions.slice(1).forEach(q => {
        document.getElementById(`q-${q.id}`).classList.add("disabled");
      });

      document.getElementById(`q-${questions[0].id}`).classList.add("active");
    }

    function renderTest(questions) {
      const container = document.getElementById("test");

      questions.forEach((q, qIndex) => {
        const qDiv = document.createElement("div");
        qDiv.className = "question-card";
        qDiv.id = `q-${q.id}`;

        const qTitle = document.createElement("h3");
        qTitle.textContent = `${qIndex + 1}. ${q.question}`;
        qDiv.appendChild(qTitle);

        if (q.type === "single" || q.type === "assertion") {
          q.options.forEach(opt => {
            const label = document.createElement("label");
            label.style.display = "block";
            const input = document.createElement("input");
            input.type = "radio";
            input.name = `q${q.id}`;
            input.value = opt;
            input.addEventListener("change", () => {
              handleAnswer(q, [opt], qDiv, qIndex);
            });
            label.appendChild(input);
            label.append(" " + opt);
            qDiv.appendChild(label);
          });
        }
        else if (q.type === "multiple") {
          q.options.forEach(opt => {
            const label = document.createElement("label");
            label.style.display = "block";
            const input = document.createElement("input");
            input.type = "checkbox";
            input.name = `q${q.id}`;
            input.value = opt;
            label.appendChild(input);
            label.append(" " + opt);
            qDiv.appendChild(label);
          });

          const submitBtn = document.createElement("button");
          submitBtn.textContent = "Submit Answer";
          submitBtn.addEventListener("click", () => {
            const selected = Array.from(qDiv.querySelectorAll("input[type=checkbox]:checked"))
              .map(cb => cb.value);
            handleAnswer(q, selected, qDiv, qIndex);
          });
          qDiv.appendChild(submitBtn);
        }
        else if (q.type === "match") {
          const keys = Object.keys(q.matchPairs);
          const values = shuffle(Object.values(q.matchPairs));

          const table = document.createElement("div");
          table.className = "match-table";

          const selects = [];

          keys.forEach(k => {
            const row = document.createElement("div");
            row.className = "match-row";

            const left = document.createElement("div");
            left.className = "match-cell";
            left.textContent = k;

            const right = document.createElement("div");
            right.className = "match-cell";
            const select = document.createElement("select");

            // Add placeholder option
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "<Select One>";
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);

            values.forEach(v => {
              const opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              select.appendChild(opt);
            });

            selects.push(select);
            right.appendChild(select);
            row.appendChild(left);
            row.appendChild(right);
            table.appendChild(row);
          });

          qDiv.appendChild(table);

          const submitBtn = document.createElement("button");
          submitBtn.textContent = "Submit Matches";
          submitBtn.disabled = true; // disabled until all dropdowns filled

          // Enable only when all dropdowns are filled
          selects.forEach(sel => {
            sel.addEventListener("change", () => {
              const allFilled = selects.every(s => s.value !== "");
              submitBtn.disabled = !allFilled;
            });
          });

          submitBtn.addEventListener("click", () => {
            const selections = {};
            keys.forEach((k, i) => {
              selections[k] = selects[i].value;
            });
            handleAnswer(q, selections, qDiv, qIndex);
          });

          qDiv.appendChild(submitBtn);
        }

        container.appendChild(qDiv);
      });
    }

    function handleAnswer(question, chosen, qDiv, qIndex) {
      if (qDiv.classList.contains("locked")) return;

      qDiv.classList.remove("active");
      qDiv.classList.add("locked");

      let isCorrect = false;

      if (question.type === "single" || question.type === "assertion") {
        isCorrect = (chosen[0] === question.answer);
      }
      else if (question.type === "multiple") {
        const correct = new Set(question.answer);
        const selected = new Set(chosen);
        isCorrect = (correct.size === selected.size && [...correct].every(x => selected.has(x)));
      }
      else if (question.type === "match") {
        isCorrect = JSON.stringify(chosen) === JSON.stringify(question.matchPairs);
      }

      if (isCorrect) {
        qDiv.insertAdjacentHTML("beforeend", `<p class="correct">‚úÖ Correct!</p>`);
        score++;
      } else {
        let correctText = "";
        if (question.type === "single" || question.type === "assertion") {
          correctText = question.answer;
        } else if (question.type === "multiple") {
          correctText = question.answer.join(", ");
        } else if (question.type === "match") {
          correctText = Object.entries(question.matchPairs)
            .map(([k,v]) => `${k} ‚Üí ${v}`)
            .join("; ");
        }
        qDiv.insertAdjacentHTML("beforeend", `<p class="wrong">‚ùå Wrong. Correct answer: ${correctText}</p>`);
      }

      const nextQ = document.getElementById(`q-${questions[qIndex + 1]?.id}`);
      if (nextQ) {
        nextQ.classList.remove("disabled");
        nextQ.classList.add("active");
      } else {
        showFinalScore();
      }
    }

    function showFinalScore() {
      const total = questions.length;
      const percent = Math.round((score / total) * 100);

      let message = "";
      let cssClass = "";

      if (percent >= 90) {
        message = "üåü Outstanding performance! You‚Äôve clearly mastered the material with confidence. Your preparation has paid off, and you‚Äôre ready to take on more advanced challenges. Keep revising lightly to maintain this level of sharpness.";
        cssClass = "excellent";
      } else if (percent >= 70) {
        message = "üëç Well done! You have a strong grasp of the concepts and only a few areas need polishing. Focus your revision on the questions you got wrong, and you‚Äôll easily move into the top performance bracket.";
        cssClass = "good";
      } else if (percent >= 50) {
        message = "üòä Decent effort! You‚Äôve understood some key concepts, but there are noticeable gaps in your knowledge. Review the areas you struggled with, and try practicing with more mock tests. A little more dedication will take you much further.";
        cssClass = "fair";
      } else {
        message = "üôå Don‚Äôt worry! Every expert was once a beginner. This score shows that you need to revisit the basics and revise systematically. Take this as a starting point ‚Äî focus on fundamentals, break your study sessions into smaller chunks, and keep practicing. Improvement will follow step by step.";
        cssClass = "poor";
      }

      document.getElementById("scoreboard").innerHTML = `
        <div><strong>Your Score:</strong> ${score} / ${total} (${percent}%)</div>
        <div id="message" class="${cssClass}">${message}</div>
      `;

      document.getElementById("restart").style.display = "inline-block";
    }

    document.getElementById("restart").addEventListener("click", startTest);
  </script>
</body>
</html>
